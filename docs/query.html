<!DOCTYPE html>

<html>
<head>
  <title>query.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>query.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);

exports.queryParser = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{
  <span class="hljs-keyword">var</span> qp = req.query;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Parse the query
Ensure empty params are treated as null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Object</span>.keys(qp).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param)</span> </span>{
    <span class="hljs-keyword">if</span> (qp[param] === <span class="hljs-string">''</span>) {
      qp[param] = <span class="hljs-literal">null</span>;
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Parse comma-delimited params and trim them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (qp.populate) {
    qp.populate = qp.populate.split(<span class="hljs-string">','</span>);
    qp.populate = qp.populate.map(<span class="hljs-built_in">Function</span>.prototype.call, <span class="hljs-built_in">String</span>.prototype.trim);
  }
  <span class="hljs-keyword">if</span> (qp.sort) {
    qp.sort = qp.sort.split(<span class="hljs-string">','</span>);
    qp.sort = qp.sort.map(<span class="hljs-built_in">Function</span>.prototype.call, <span class="hljs-built_in">String</span>.prototype.trim);
    <span class="hljs-keyword">var</span> newVal = {};
    qp.sort.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param)</span> </span>{
      <span class="hljs-keyword">if</span> (param.lastIndexOf(<span class="hljs-string">'-'</span>, <span class="hljs-number">0</span>) === <span class="hljs-number">0</span>) {
        newVal[param.substring(<span class="hljs-number">1</span>)] = -<span class="hljs-number">1</span>;
      } <span class="hljs-keyword">else</span> {
        newVal[param] = <span class="hljs-number">1</span>;
      }
    });
    qp.sort = newVal;
  }
  next();
};

exports.docFetcher = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(thiz)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{
    <span class="hljs-keyword">if</span> (!req.params.id) {
      <span class="hljs-keyword">return</span> next();
    }
    <span class="hljs-keyword">var</span> query = {};
    <span class="hljs-keyword">var</span> idField = thiz.parent ? thiz.parent.id : thiz.id;
    query[idField] = req.params.id;

    <span class="hljs-keyword">var</span> model = thiz.parent ? thiz.parent.model : thiz.model;
    <span class="hljs-keyword">var</span> q = model.findOne(query);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Apply population if no parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!thiz.parent &amp;&amp; req.query.populate) {
      <span class="hljs-keyword">try</span> {
        exports.applyPopulate(q, thiz, req.query.populate, res);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">if</span> (!e.code) {
          <span class="hljs-keyword">throw</span> e;
        }
        <span class="hljs-keyword">return</span> e;
      }
    }
    q.exec(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, doc)</span> </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(err);
      }
      <span class="hljs-keyword">if</span> (!doc) {
        <span class="hljs-keyword">return</span> res.error(<span class="hljs-number">404</span>, model.modelName + <span class="hljs-string">' "'</span> + req.params.id + <span class="hljs-string">'" not found.'</span>);
      }

      <span class="hljs-keyword">if</span> (!thiz.parent) {
        req.doc = doc;
        <span class="hljs-keyword">return</span> next();
      }
      req.parentDoc = doc;

      <span class="hljs-keyword">if</span> (!req.params.sid) {
        <span class="hljs-keyword">return</span> next();
      }

      query = {};
      query[thiz.id] = req.params.sid;
      query[thiz.parentCorrespondsTo] = doc._id;

      <span class="hljs-keyword">var</span> q = thiz.model.findOne(query);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Apply population if parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (req.query.populate) {
        exports.applyPopulate(q, thiz.model, req.query.populate, res);
      }
      q.exec(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, sai)</span> </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> next(err);
        }

        <span class="hljs-keyword">if</span> (!sai) {
          <span class="hljs-keyword">return</span> res.error(<span class="hljs-number">404</span>, thiz.model.modelName + <span class="hljs-string">' "'</span> + req.params.sid + <span class="hljs-string">'" not found.'</span>);
        }

        req.doc = sai; <span class="hljs-comment">// get sai from sid</span>
        <span class="hljs-keyword">return</span> next();
      });
    });
  };
};

exports.applyQueryFields = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, query, model, res)</span> </span>{
  <span class="hljs-keyword">var</span> Mod = model.model;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Limit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (req.query.limit) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(req.query.limit)) {
      <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'Limit must be a number.'</span>);
    }
    query.limit(req.query.limit);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Skip</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (req.query.skip) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(req.query.skip)) {
      <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'Skip must be a number.'</span>);
    }
    query.skip(req.query.skip);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Sort</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (req.query.sort) {
    _.forIn(req.query.sort, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, toSort)</span> </span>{
      <span class="hljs-keyword">if</span> (!_.has(Mod.schema.paths, toSort)) {
        <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'Field "'</span> + toSort + <span class="hljs-string">'" does not exist.'</span>);
      }
      <span class="hljs-keyword">if</span> (_.contains(model.restricted, toSort)) {
        <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">401</span>, <span class="hljs-string">'Cannot sort restricted field "'</span> + toSort + <span class="hljs-string">'".'</span>);
      }
    });
    query.sort(req.query.sort);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Mod.schema.eachPath(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">if</span> (!req.query.hasOwnProperty(name)) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> val = req.query[name];

    <span class="hljs-keyword">if</span> (_.contains(model.restricted, name)) {
      <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">401</span>, <span class="hljs-string">'Cannot access restricted field "'</span> + name + <span class="hljs-string">'".'</span>);
    }
    query.where(name).equals(val);
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (req.query.filter) {
    <span class="hljs-keyword">var</span> filters = utils.parseFilterString(req.query.filter);
    _.forEach(filters, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filter)</span> </span>{
      <span class="hljs-keyword">if</span> (!_.has(model.filters, filter[<span class="hljs-number">0</span>])) {
        <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'The filter "'</span> + filter + <span class="hljs-string">'" does not exist.'</span>);
      }
      <span class="hljs-keyword">var</span> filterFn = model.filters[filter[<span class="hljs-number">0</span>]];</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Construct our filter arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> args = [];
      args.push(req);
      args.push(query);
      args.push.apply(args, filter.slice(<span class="hljs-number">1</span>));

      <span class="hljs-keyword">try</span> {
        filterFn.apply(model, args);
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'Could not apply filter "'</span> + filter + <span class="hljs-string">'" due to error: '</span> + err.message);
      }
    });
  }
};

exports.applyPopulate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query, model, populate, res)</span> </span>{
  <span class="hljs-keyword">var</span> Mod = model.model;
  _.forEach(populate, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(toPopulate)</span> </span>{
      <span class="hljs-keyword">if</span> (!Mod.schema.paths.hasOwnProperty(toPopulate)) {
        <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'Field "'</span> + toPopulate + <span class="hljs-string">'" does not exist.'</span>);
      }

      <span class="hljs-keyword">var</span> type = Mod.schema.paths[toPopulate].options.type;
      <span class="hljs-keyword">if</span> (type[<span class="hljs-number">0</span>]) {
        type = type[<span class="hljs-number">0</span>].type;
      }

      <span class="hljs-keyword">if</span> (type !== mongoose.Schema.Types.ObjectId) {
        <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">400</span>, <span class="hljs-string">'Field "'</span> + toPopulate + <span class="hljs-string">'" does not support population as it is not an ObjectId.'</span>);
      }

    <span class="hljs-keyword">if</span> (_.contains(model.restricted, toPopulate)) {
      <span class="hljs-keyword">throw</span> res.error(<span class="hljs-number">401</span>, <span class="hljs-string">'Cannot populate restricted field "'</span> + toPopulate + <span class="hljs-string">'".'</span>);
    }
    query.populate(toPopulate);
  });
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
