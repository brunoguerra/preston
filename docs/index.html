<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1">
<title>Preston &#8212; REST API Framework for Mongoose and Node</title>
<style>

.back-to-top {
    display: none;
    position: fixed;
    right: 1em;
    bottom: 1em;
    z-index: 999;
}

.back-to-top a {
    display: block;
    padding: .5em .5em .5em 1.5em;
    line-height: 1em;
    border-radius: .25em;
    background: #fff url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxM3B4IiBoZWlnaHQ9IjE0cHgiIHZpZXdCb3g9IjAgMCAxMyAxNCI+CiAgICA8cGF0aCBkPSJNNy4xODc2MTE1NiwxMyBMNy4xODc2MTE1Niw1LjQ5MjQ5NzAzIEwxMC40NTg3ODUzLDUuNDkyNDk3MDMgTDUuMDk5MzE3NjMsMC4xMTM1NTgxMjkgTC0wLjI2MDE1LDUuNDkyNDk3MDMgTDMuMDExMDIzNzEsNS40OTI0OTcwMyBMMy4wMTEwMjM3MSwxMyBMNy4xODc2MTE1NiwxMyBaIiBmaWxsPSIjNDI4YmNhIj48L3BhdGg+Cjwvc3ZnPgo=) no-repeat .5em center;
}

.menu {
    margin: 1.5em 0 0 0;
    padding: 0;
}

.menu li {
    list-style: none;
}

.menu li a {
    display: block;
    padding: .25em;
}

.menu li ul {
    margin: .25em 0 .25em 1em;
    padding: 0;
}

.menu .scope-private {
    opacity: 0.5;
}

.method h2 {
    line-height: 1.3em;
    text-overflow: ellipsis;
    overflow: hidden;
}

.permalink {
    position: absolute;
    margin-left: -.75em;
    font-weight: normal;
    color: #eee;
}

.permalink:hover {
    color: #666;
    text-decoration: none;
}

.bs-footer {
    margin: 50px auto;
    color: #777;
    text-align: center;
}

pre .hljs {
    padding: 0;
    background: none;
}

</style>
<script>
(function(e,i,t){"use strict";var c=e.location.protocol==="file:"?"http:":e.location.protocol,o=["//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css","//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/github.min.css","//code.jquery.com/jquery-2.1.1.js","//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js"];function s(e){var l;if(e.match(/\.js$/)){l=i.createElement("script");l.setAttribute("src",c+e)}else if(e.match(/\.css$/)){l=i.createElement("link");l.setAttribute("rel","stylesheet");l.setAttribute("href",c+e)}l.addEventListener("load",function(){if(o.length){s(o.shift())}else{if($.isReady){t()}else{$(document).ready(t)}}});i.head.appendChild(l)}s(o.shift())})(window,document,function(){"use strict";var e=window.location.hash,i=$('[id="'+e.replace(/#/,"")+'"]'),t=$(".code"),c=$(".scope-private"),o=$(".toggle-code-blocks"),s=$(".toggle-private"),l=$(".back-to-top");function n(){if(window.scrollY>100&&l.not(":visible")){l.fadeIn()}else if(window.scrollY<100&&l.is(":visible")){l.fadeOut()}}o.on("click",function(){if(o.is(":checked")){t.show()}else{t.hide()}});s.on("click",function(){if(s.is(":checked")){c.show()}else{c.hide()}});t.hide();c.hide();if(i.length&&!i.is(":visible")){s.trigger("click")}$(".examples pre code, .code pre code").each(function(){hljs.highlightBlock(this)});$(window).on("scroll",n);n()});
</script>
</head>

<body>

<div class="back-to-top"><a href="#">Back to Top</a></div>

<div class="wrap">

    <div class="container">

        <div class="page-header">

            <div class="pull-right hidden-sm hidden-xs">

                <div>
                    <label>
                        <input type="checkbox" name="toggle-code" class="toggle-code-blocks">
                        Toggle Code Blocks
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" name="toggle-private" class="toggle-private">
                        Toggle Private Methods
                    </label>
                </div>

            </div>

            <h1>Preston <small>REST API Framework for Mongoose and Node</small></h1>

        </div>

        <div class="row">

            <div class="col-md-3 hidden-sm hidden-xs">

                <ul class="menu">

                    

                    <li>
                        <b>model.js</b>
                        <ul>

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model">Model()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.modifyparam">Model.modifyParam()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.applymodifiers">Model.applyModifiers()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.limit">Model.limit()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.filter">Model.filter()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.transform">Model.transform()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.transformpopulate">Model.transformPopulate()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.applytransforms">Model.applyTransforms()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.use">Model.use()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.submodel">Model.submodel()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.serve">Model.serve()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#model.js-model.prototype.middleware">Model.middleware()</a>
                                    </li>

                                

                            

                        

                        </ul>

                    </li>

                    

                    <li>
                        <b>preston.js</b>
                        <ul>

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi">RestAPI()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.setup">RestAPI.setup()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.asfunction">RestAPI.asFunction()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.use">RestAPI.use()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.finish">RestAPI.finish()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.model">RestAPI.model()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.addmodels">RestAPI.addModels()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.modelsmiddleware">RestAPI.modelsMiddleware()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restapi.prototype.middleware">RestAPI.middleware()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restifier">restifier</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#preston.js-restifier.api">restifier.api()</a>
                                    </li>

                                

                            

                        

                        </ul>

                    </li>

                    

                    <li>
                        <b>query.js</b>
                        <ul>

                        

                            

                                

                            

                        

                        </ul>

                    </li>

                    

                    <li>
                        <b>routes.js</b>
                        <ul>

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#routes.js-exports.query">exports.query()</a>
                                    </li>

                                

                            

                        

                            

                                

                                    <li class="scope-public">
                                        <a href="#routes.js-exports.default">exports.default()</a>
                                    </li>

                                

                            

                        

                        </ul>

                    </li>

                    

                    <li>
                        <b>utils.js</b>
                        <ul>

                        

                            

                                

                            

                        

                        </ul>

                    </li>

                    

                </ul>

            </div>

            <div class="col-md-9">

                

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model">
                                    <a href="#model.js-model" class="permalink">#</a> Model()
                                    
                                </h2>

                                <p>Constructor.</p>

                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                    

                                        

                                    

                                        

                                            <p>
                                                <b>restifier</b>
                                                
                                                    <code>RestAPI</code>
                                                
                                                
                                            </p>
                                            <p>- The RestAPI instance</p>

                                        

                                    

                                        

                                            <p>
                                                <b>model</b>
                                                
                                                    <code>mongoose.Model</code>
                                                
                                                
                                            </p>
                                            <p>- The mongoose model that is being restified.</p>

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>function Model(restifier, model) {
  var thiz = this;

  this.restifier = restifier;
  this.model = model;

  // Special fields
  var id;
  var restricted = this.restricted = [];
  model.schema.eachPath(function(pathName, path) {
    if (path.options.restricted) {
      restricted.push(pathName);
    }
    if (path.options.id) {
      id = pathName;
    }
  });
  this.id = id || &#x27;_id&#x27;;

  this.modifiers = [];
  this.filters = {};
  this.transformers = [];
  this.submodels = {};
  this.middlewares = {};

  // Remove restricted
  this.transform(function(req, doc) {
    _.forEach(restricted, function(path) {
      delete doc[path];
    });
  });

  // Add id field
  this.transform(function(req, doc) {
    doc.id = doc[thiz.id];
  });

  // Call setupPreston static if exists
  var setup = model.schema.statics.setupPreston;
  if (setup) {
    setup.call(model.schema, this);
  }
}</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.modifyparam">
                                    <a href="#model.js-model.prototype.modifyparam" class="permalink">#</a> Model.modifyParam()
                                    
                                </h2>

                                <p>Modifies a query parameter. Modifiers alter the query parameters that will<br />be passed to the pipeline. Modifiers are applied before any logic is called.<br />To modify a parameter, pass the name of the parameter you wish to modify and<br />a callback that returns the modified value of the parameter.</p>

                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                    

                                        

                                            <p>
                                                <b>param</b>
                                                
                                                    <code>String</code>
                                                
                                                
                                            </p>
                                            <p>- The param to modify. Can be limit, skip, populate, sort,   any document field, or a parameter handled by a custom middleware.</p>

                                        

                                    

                                        

                                            <p>
                                                <b>modifier</b>
                                                
                                                    <code>Function</code>
                                                
                                                
                                            </p>
                                            <p>- The modifier(req, value[, cb]) function. Should return the new value.</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.modifyParam = function(param, modifier) {
  this.modifiers.push({
    param: param,
    fn: modifier
  });
  return this;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.applymodifiers">
                                    <a href="#model.js-model.prototype.applymodifiers" class="permalink">#</a> Model.applyModifiers()
                                    
                                </h2>

                                <p>Applies the modifiers of this model onto a request.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>request</b>
                                                
                                                    <code>Request</code>
                                                
                                                
                                            </p>
                                            <p>- The request</p>

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.applyModifiers = function(request, done) {
  function applyModifier(req, mod, next) {
    var modFn = mod.fn;
    var val = req.query[mod.param];

    // Sync
    if (modFn.length === 2) {
      try {
        var ret = modFn(req, val);
        if (ret === false) {
          delete req.query[mod.param];
        } else {
          req.query[mod.param] = ret;
        }
      } catch (err) {
        return next(err, null);
      }
      return next(null, req);
    }

    // Async
    modFn(req, val, function(err, ret) {
      if (ret === false) {
        delete req.query[mod.param];
      } else {
        req.query[mod.param] = ret;
      }
      return next(err, req);
    });
  }

  async.reduce(this.modifiers, request, applyModifier, done);
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.limit">
                                    <a href="#model.js-model.prototype.limit" class="permalink">#</a> Model.limit()
                                    
                                </h2>

                                <p>Modifies the limit parameter. Internally, this applies a {@link modifyParam} that restricts<br />the limit parameter to be no greater than what is given here.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                    

                                        

                                            <p>
                                                <b>num</b>
                                                
                                                    <code>Number</code>
                                                
                                                
                                            </p>
                                            <p>- The maximum number of documents that can be returned.</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.limit = function(num) {
  return this.modifyParam(&#x27;limit&#x27;, function(req, value) {
    return (value &amp;&amp; !isNaN(value)) ? Math.min(num, value) : num;
  });
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.filter">
                                    <a href="#model.js-model.prototype.filter" class="permalink">#</a> Model.filter()
                                    
                                </h2>

                                <p>Adds a filter to this model. Filters are user-defined functions that modify the<br />query. They work very similarly to AngularJS filters. They can be chained and<br />take parameters, allowing immense flexibility for developers to add features to APIs.</p>

                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                    

                                        

                                            <p>
                                                <b>name</b>
                                                
                                                    <code>String</code>
                                                
                                                
                                            </p>
                                            <p>- The name of the filter (case sensitive).</p>

                                        

                                    

                                        

                                            <p>
                                                <b>filter</b>
                                                
                                                    <code>Function</code>
                                                
                                                
                                            </p>
                                            <p>- The filter function (req, query, params...) that will be applied to queries.</p>

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="examples">

                                    <h3>Examples</h3>

                                    <p>Filters are called like this:</p><pre><code>GET /people?filter=children
</code></pre><p>They can also be chained like this:</p><pre><code>GET /people?filter=children | proximity 5
</code></pre>

                                </section>

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.filter = function(name, filter) {
  this.filters[name] = filter;
  return this;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.transform">
                                    <a href="#model.js-model.prototype.transform" class="permalink">#</a> Model.transform()
                                    
                                </h2>

                                <p>Adds a transformer to this model. Transformers change the returned results.<br />One transformer is built in, the restricted transformer, and cannot be changed.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                    

                                        

                                            <p>
                                                <b>transformer</b>
                                                
                                                    <code>Function</code>
                                                
                                                
                                            </p>
                                            <p>- The transformer(req, doc[, next]).</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.transform = function(transformer) {
  this.transformers.push(transformer);
  return this;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.transformpopulate">
                                    <a href="#model.js-model.prototype.transformpopulate" class="permalink">#</a> Model.transformPopulate()
                                    
                                </h2>

                                <p>Adds a population transformer to this model. Population transformers are<br />transformers that operate on populated fields. They can be used to make<br />your application more secure by removing fields you don&#39;t want people to see.</p>

                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                    

                                        

                                            <p>
                                                <b>field</b>
                                                
                                                    <code>String</code>
                                                
                                                
                                            </p>
                                            <p>- The populated field to transform.</p>

                                        

                                    

                                        

                                            <p>
                                                <b>transformer</b>
                                                
                                                    <code>Function</code>
                                                
                                                
                                            </p>
                                            <p>- The transform function(req, doc[, next])</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.transformPopulate = function(field, transformer) {
  // Wrapper so we have the correct number of args
  function callTransform(req, doc, next) {
    var pop = doc[field];
    if (!pop) {
      return;
    }

    // Normalize
    var single = false;
    if (typeof pop === &#x27;object&#x27; &amp;&amp; !Array.isArray(pop)) {
      pop = [pop];
      single = true;
    }

    // Ensure array, as it isn&#x27;t an object at this point
    if (!Array.isArray(pop)) {
      // fail silently. This may change in the future
      if (next) {
        return next();
      } else {
        return;
      }
    }

    // Loop through
    // Sync
    if (transformer.length === 2) {
      _.forEach(pop, function(subDoc) {
        transformer(req, subDoc);
      });
      return;
    }

    // Async
    async.map(pop, function(subDoc, done) {
      transformer(req, subDoc, function(err) {
        return done(err, subDoc);
      });
    }, function(err, result) {
      if (single) {
        result = result[0];
      }
      doc[field] = result;
      next();
    });
  }

  // Synchronous
  if (transformer.length === 2) {
    return this.transform(function(req, doc) {
      callTransform(req, doc);
    });
  }

  // Async
  return this.transform(function(req, doc, next) {
    callTransform(req, doc, next);
  });
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.applytransforms">
                                    <a href="#model.js-model.prototype.applytransforms" class="permalink">#</a> Model.applyTransforms()
                                    
                                </h2>

                                <p>Applies all of the transforms defined on this model on a document.</p>

                                
                                
                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>req</b>
                                                
                                                    <code>Request</code>
                                                
                                                
                                            </p>
                                            <p>- The request.</p>

                                        

                                    

                                        

                                            <p>
                                                <b>doc</b>
                                                
                                                    <code>Document</code>
                                                
                                                
                                            </p>
                                            <p>- The document to apply the transforms to.</p>

                                        

                                    

                                        

                                            <p>
                                                <b>[cb]</b>
                                                
                                                    <code>Function</code>
                                                
                                                
                                            </p>
                                            <p>- The cb(err, result) where result is the transformed document.</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.applyTransforms = function(req, doc, cb) {
  async.reduce(this.transformers, doc.toObject(), function(memo, tf, next) {
    if (tf.length === 2) {
      tf(req, memo);
      next(null, memo);
    } else {
      tf(req, memo, function(err) {
        return next(err, memo);
      });
    }
  }, function(err, result) {
    cb(err, result);
  });
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.use">
                                    <a href="#model.js-model.prototype.use" class="permalink">#</a> Model.use()
                                    
                                </h2>

                                <p>Uses a middleware on a certain route. These middlewares are called in the order that they are added<br />to this model.</p>

                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>route</b>
                                                
                                                    <code>String</code>
                                                
                                                
                                            </p>
                                            <p>- The route. Can be one of all, query, create, get, update, destroy.</p>

                                        

                                    

                                        

                                            <p>
                                                <b>middleware</b>
                                                
                                                    <code>Function</code>
                                                
                                                
                                            </p>
                                            <p>- The middleware(req, res, next).</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.use = function(route, middleware) {
  route = route.toLowerCase();
  var arr = this.middlewares[route] || (this.middlewares[route] = []);
  arr.push(middleware);
  return this;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.submodel">
                                    <a href="#model.js-model.prototype.submodel" class="permalink">#</a> Model.submodel()
                                    
                                </h2>

                                <p>Makes a field a submodel, meaning that field<br />has its own routes for query/crud.</p>

                                
                                
                                
                                
                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>-</b>
                                                
                                                    <code>field</code>
                                                
                                                
                                            </p>
                                            <p>The field to submodel</p>

                                        

                                    

                                        

                                            <p>
                                                <b>-</b>
                                                
                                                    <code>correspondsTo</code>
                                                
                                                
                                            </p>
                                            <p>The submodel's field that corresponds to this model.</p>

                                        

                                    

                                        

                                            <p>
                                                <b>-</b>
                                                
                                                    <code>model</code>
                                                
                                                
                                            </p>
                                            <p>The mongoose model</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="examples">

                                    <h3>Examples</h3>

                                    <p>Note that you cannot create a submodel of a submodel.</p>

                                </section>

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.submodel = function(field, correspondsTo, model) {
  // Check if valid
  if (this.parent) {
    throw new Error(&#x27;Submodels of submodels not allowed for model &quot;&#x27; + this.model.modelName + &#x27;&quot;.&#x27;);
  }

  var submodel = this.submodels[field] = new Model(this.restifier, model);
  submodel.parent = this;
  submodel.parentField = field;
  submodel.parentCorrespondsTo = correspondsTo;
  return submodel;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.serve">
                                    <a href="#model.js-model.prototype.serve" class="permalink">#</a> Model.serve()
                                    
                                </h2>

                                <p>Serves this model on a RESTful API.<br />Don&#39;t use this method; use the middleware instead via {@link RestAPI#middleware}.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>router</b>
                                                
                                                    <code>express.Router</code>
                                                
                                                
                                            </p>
                                            <p>- The Express router to serve the model on.</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.serve = function(router) {
  var thiz = this;

  var uriBase = &#x27;/&#x27; + (this.parent || this).model.collection.name;
  var uriDoc = uriBase + &#x27;/:id&#x27;;
  if (this.parent) {
    uriBase = uriDoc + &#x27;/&#x27; + this.parentField;
    uriDoc = uriBase + &#x27;/:sid&#x27;;
  }

  var middleware = [queryHelper.queryParser, queryHelper.docFetcher(this)];
  middleware = middleware.concat(this.middlewares.all || []); // &#x27;all&#x27; middleware
  var routeMiddleware = {};
  [&#x27;query&#x27;, &#x27;create&#x27;, &#x27;get&#x27;, &#x27;update&#x27;, &#x27;destroy&#x27;].filter(function(route) {
    routeMiddleware[route] = middleware.slice()
      .concat(thiz.middlewares[route] || []);
  });

  router.route(uriBase)
    .get(routeMiddleware.query, routes.query(this))
    .post(routeMiddleware.create, routes.create(this))
    .all(routes.default);

  router.route(uriDoc)
    .get(routeMiddleware.get, routes.get(this))
    .put(routeMiddleware.update, routes.update(this))
    .patch(routeMiddleware.update, routes.update(this))
    .delete(routeMiddleware.destroy, routes.destroy(this))
    .all(routes.default);

  return this;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="model.js-model.prototype.middleware">
                                    <a href="#model.js-model.prototype.middleware" class="permalink">#</a> Model.middleware()
                                    
                                </h2>

                                <p>Creates a middleware of this model. It is preferable to use {@link RestAPI#middleware}<br />as that function provides the necessary error handling and invalid method middlewares.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>Model.prototype.middleware = function() {
  var router = express.Router();
  this.serve(router);
  return router;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi">
                                    <a href="#preston.js-restapi" class="permalink">#</a> RestAPI()
                                    
                                </h2>

                                <p>Represents a RESTful API powered by Restifier.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>function RestAPI() {
  this.models = {};
  this.router = express.Router();
  this.router.use(require(&#x27;res-error&#x27;)({
    log: false
  }));
}</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.setup">
                                    <a href="#preston.js-restapi.prototype.setup" class="permalink">#</a> RestAPI.setup()
                                    
                                </h2>

                                <p>Gateway function that can add model(s) or return initialization<br />middleware depending on the arguments passed to it.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.setup = function() {
  var args = Array.prototype.slice.call(arguments, 0);
  if (args.length &gt; 1) {
    return this.modelsMiddleware(args);
  }

  if (args.length === 0 || !args[0].schema) {
    return this.router;
  }
  return this.model(args[0]);
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.asfunction">
                                    <a href="#preston.js-restapi.prototype.asfunction" class="permalink">#</a> RestAPI.asFunction()
                                    
                                </h2>

                                <p>Creates a setup function for this RestAPI.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.asFunction = function() {
  return functionize(this, this.setup);
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.use">
                                    <a href="#preston.js-restapi.prototype.use" class="permalink">#</a> RestAPI.use()
                                    
                                </h2>

                                <p>Applies middleware to this RestAPI. Uses express.Router#use.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.use = function() {
  this.router.use.apply(this.router, arguments);
  return this;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.finish">
                                    <a href="#preston.js-restapi.prototype.finish" class="permalink">#</a> RestAPI.finish()
                                    
                                </h2>

                                <p>Should be called after the app has been created.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.finish = function() {
  return function(req, res, next) {
    return res.error(404, &#x27;Path not found.&#x27;);
  };
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.model">
                                    <a href="#preston.js-restapi.prototype.model" class="permalink">#</a> RestAPI.model()
                                    
                                </h2>

                                <p>Adds a model to this RestAPI.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>mong</b>
                                                
                                                    <code>mongoose.Model</code>
                                                
                                                
                                            </p>
                                            <p>The mongoose model</p>

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.model = function(mong) {
  var m = new Model(this, mong);
  this.models[mong.modelName] = m;
  return m;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.addmodels">
                                    <a href="#preston.js-restapi.prototype.addmodels" class="permalink">#</a> RestAPI.addModels()
                                    
                                </h2>

                                <p>Adds multiple models to this RestAPI.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>mongs</b>
                                                
                                                    <code>mongoose.Model[]</code>
                                                
                                                
                                            </p>
                                            <p>The mongoose models</p>

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.addModels = function(mongs) {
  return _.map(mongs, function(mong) {
    return this.model(mong);
  }, this);
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.modelsmiddleware">
                                    <a href="#preston.js-restapi.prototype.modelsmiddleware" class="permalink">#</a> RestAPI.modelsMiddleware()
                                    
                                </h2>

                                <p>Creates a middleware out of multiple models.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>mongs</b>
                                                
                                                    <code>mongoose.Model[]</code>
                                                
                                                
                                            </p>
                                            <p>The mongoose models</p>

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.modelsMiddleware = function(mongs) {
  var router = express.Router();
  _.forEach(this.addModels(mongs), function(model) {
    model.serve(router);
  });
  return router;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restapi.prototype.middleware">
                                    <a href="#preston.js-restapi.prototype.middleware" class="permalink">#</a> RestAPI.middleware()
                                    
                                </h2>

                                <p>Creates middleware that encompasses all registered models.<br />This is equivalent to calling <code>model.middleware()</code> for each<br />individual model, plus calling <code>restifier.initialize()</code> and<br /><code>restifier.finish()</code>.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>RestAPI.prototype.middleware = function() {
  var router = express.Router();
  router.use(this.router);
  _.forEach(this.models, function(model) {
    router.use(model.middleware());
    _.forEach(model.submodels, function(submodel) {
      router.use(submodel.middleware());
    });
  });
  router.use(this.finish());
  return router;
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restifier">
                                    <a href="#preston.js-restifier" class="permalink">#</a> restifier
                                    
                                </h2>

                                <p>The main function. Wraps {@link RestAPI#setup}.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>var restifier = module.exports = (new RestAPI()).asFunction();</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="preston.js-restifier.api">
                                    <a href="#preston.js-restifier.api" class="permalink">#</a> restifier.api()
                                    
                                </h2>

                                <p>Factory function to create a new {@link RestAPI}.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>restifier.api = function() {
  return new RestAPI();
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                

                

                    

                        

                    

                

                

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="routes.js-exports.query">
                                    <a href="#routes.js-exports.query" class="permalink">#</a> exports.query()
                                    
                                </h2>

                                <p>The query route.</p>

                                
                                
                                

                                

                                <section class="parameters">

                                    <h3>Parameters</h3>

                                    

                                        

                                            <p>
                                                <b>model</b>
                                                
                                                    <code>Model</code>
                                                
                                                
                                            </p>
                                            <p>- The {@link Model}.</p>

                                        

                                    

                                        

                                    

                                </section>

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>exports.query = function(model) {
  var Mod = model.model;
  return function(req, res) {
    var query = Mod.find();
    var reqQuery = req.query;

    if (req.parentDoc) {
      query.where(model.parentCorrespondsTo).equals(req.parentDoc);
    }

    model.applyModifiers(req, function(err, request) {
      req = request;
      try {
        queryHelper.applyQueryFields(req, query, model, res);
        if (reqQuery.populate) {
          queryHelper.applyPopulate(query, model, reqQuery.populate, res);
        }
      } catch (err) {
        if (!err.code) {
          throw err;
        }
        return;
      }

      query.exec(function(err, docs) {
        if (err) {
          throw err;
        }
        async.map(docs, function(doc, next) {
          model.applyTransforms(req, doc, next);
        }, function(e, jsoned) {
          res.json(jsoned);
        });
      });
    });
  };
};

exports.create = function(model) {
  var Mod = model.model;
  return function(req, res) {
    var doc = new Mod(req.body);
    if (req.parentDoc) {
      doc[model.parentCorrespondsTo] = req.parentDoc;
    }
    doc.save(function(err) {
      if (err) {
        if (err.err &amp;&amp; err.err.match(/duplicate key error/)) {
          return res.error(409, Mod.modelName + &#x27; already exists.&#x27;);
        }
        return res.error(500, err.message);
      }
      model.applyTransforms(req, doc, function(err, jsoned) {
        res.json(jsoned);
      });
    });
  };
};

exports.get = function(model) {
  return function(req, res) {
    model.applyTransforms(req, req.doc, function(err, jsoned) {
      res.json(jsoned);
    });
  };
};

exports.update = function(model) {
  return function(req, res) {
    var doc = req.doc;
    var body = req.body;
    for (var prop in body) {
      if (!_.has(body, prop)) {
        continue;
      }
      doc[prop] = body[prop];
    }

    doc.save(function(err) {
      if (err) {
        return res.error(500, err);
      }
      model.applyTransforms(req, doc, function(err, jsoned) {
        res.json(jsoned);
      });
    });
  };
};

exports.destroy = function(model) {
  return function(req, res) {
    req.doc.remove(function(err) {
      if (err) {
        return res.error(500, err);
      }
      return res.json({
        success: true
      });
    });
  };
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                                    

                                

                                    

                                

                            </div>

                        

                    

                

                    

                        

                            <div class="method scope-public">

                                

                                <h2 id="routes.js-exports.default">
                                    <a href="#routes.js-exports.default" class="permalink">#</a> exports.default()
                                    
                                </h2>

                                <p>The default route that will be called if nothing else is.</p>

                                

                                

                                

                                

                                

                                <section class="code">

                                    <h3>Code</h3>

                                    <pre><code>exports.default = function(req, res, next) {
  return res.error(405, req.method + &#x27; not allowed on path &#x27; + req.path + &#x27;.&#x27;);
};</code></pre>

                                </section>

                                <h3>Returns</h3>

                                

                            </div>

                        

                    

                

                

                

                    

                        

                    

                

                

            </div>

        </div>

    </div>

</div>

<footer class="bs-footer">

    <div class="container">

        <p>Documentation generated with <a href="https://github.com/neogeek/doxdox">doxdox</a>.</p>

    </div>

</footer>

</body>
</html>
