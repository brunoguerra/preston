<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Preston Index</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Preston</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Model.html">Model</a>
						</li>
						
						<li>
							<a href="RestAPI.html">RestAPI</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#api">api</a>
						</li>
						
						<li>
							<a href="global.html#default">default</a>
						</li>
						
						<li>
							<a href="global.html#query">query</a>
						</li>
						
						<li>
							<a href="global.html#restifier">restifier</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
		<div class="span8">
			
				<div id="main">
					


	
	<span class="page-title">Index</span>
	
	












	
	





    <section class="readme-section">
        <article><h1>Preston</h1>
<p>Piece-of-cake REST on Node.</p>
<p>Preston serves Mongoose models on an extensible RESTful API. It handles routing and provides extensibility.</p>
<p><a href="https://waffle.io/simplyianm/preston"><img src="https://badge.waffle.io/simplyianm/preston.png?label=ready&amp;title=Ready" alt="Stories in Ready"></a>
<a href="http://travis-ci.org/simplyianm/preston"><img src="https://secure.travis-ci.org/simplyianm/preston.png" alt="build status"></a>
<a href="https://coveralls.io/r/simplyianm/preston"><img src="https://img.shields.io/coveralls/simplyianm/preston.svg" alt="Coverage Status"></a></p>
<h3>Features at a Glance</h3>
<ul>
<li><strong>Tight integration with Mongoose and Express.</strong><ul>
<li>An Express middleware. Put it on its own route and the rest of your code is left untouched.</li>
<li>Configured within the Mongoose schema. No need to deal with messy configuration objects.</li>
</ul>
</li>
<li><strong>Query/Create/Get/Update/Destroy</strong><ul>
<li>Everything you'd ever need from a REST API (other than auth) is already included.</li>
<li>Middleware supported on each route, so integration with things like Passport is very simple</li>
</ul>
</li>
<li><strong><a href="#filters">Flexible query filtering system.</a></strong></li>
<li><strong><a href="#transformers">Document transformer system.</a></strong> Control what gets sent to which clients.</li>
<li><strong><a href="#angularjs-integration">Built with Angular in mind.</a></strong></li>
</ul>
<h2>Installation</h2>
<p>This module is installed via npm:</p>
<pre><code class="lang-bash">$ npm install preston --save</code></pre>
<h2>Example</h2>
<p>The following example serves the <code>User</code> and <code>Badge</code> models on a RESTful API.</p>
<pre><code class="lang-js">var express = require('express');
var preston = require('preston');

var app = express();

app.use(require('body-parser').json()); // Required

var User = preston(mongoose.model('User', new mongoose.Schema({
  name: {
    type: String,
    id: true, // The id used in the route
    unique: true
  },
  password: {
    type: String,
    restricted: true // Don't display this field to anyone!
  }
})));

// A nested route
var Badge = User.submodel('badges', 'owner', mongoose.model('Badge', new mongoose.Schema({
  owner: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  },
  id: {
    type: Number,
    id: true,
    unique: true
  },
  content: String
})));

app.use('/api', preston.middleware()); // Serve the api on /api.

app.listen(3000);</code></pre>
<h2>REST API</h2>
<p>Preston uses the MongoDB collection name to determine the name of the base route, so the <code>User</code> model would create routes under <code>/users</code>.</p>
<h3>Query</h3>
<p>Querying takes in the following parameters:
<em> <code>field</code> - Replace <code>field</code> with any field in your Mongoose model, and it will check for equality.
</em> <code>populate</code> - Comma-delimited list of fields to populate
<em> <code>sort</code> - Sorts by the given fields in the given order, comma delimited. A <code>-</code> sign will sort descending.
</em> <code>limit</code> - Limits the number of returned results.
<em> <code>skip</code> - Skips a number of results. Useful for pagination when combined with <code>limit</code>.
</em> <code>filter</code> - Applies a filter. See the Filters section for more details.</p>
<pre><code>GET /users
GET /users?field=value
GET /users?populate=posts,comments
GET /users?sort=field,-field2
GET /users?limit=10&amp;skip=10
GET /users?filter=filter1|filter2
GET /users/Bob/badges?sort=date</code></pre>
<h3>Create</h3>
<pre><code>POST /users
POST /users/Bob/badges</code></pre>
<h3>Get</h3>
<p>Get supports one parameter, the <code>populate</code> field.</p>
<pre><code>GET /users/Bob
GET /users/Bob?populate=posts
GET /users/Bob/badges/1
GET /users/Bob/badges/1?populate=things</code></pre>
<h3>Update</h3>
<p>PUT and PATCH are handled the same way.</p>
<pre><code>PUT /users/Bob
PATCH /users/Bob
PUT /users/Bob/badges/1
PATCH /users/Bob/badges/1</code></pre>
<h3>Destroy</h3>
<pre><code>DELETE /users/Bob
DELETE /users/Bob/badges/1</code></pre>
<h2>Creating an API</h2>
<p>First, declare all of your models using <code>preston(mongooseModel)</code>. This function returns a <code>Model</code> object which can be altered. (see the JSDocs)</p>
<p>Next, serve the API as middleware:</p>
<pre><code>app.use('/api', preston.middleware());</code></pre>
<p>This will create a middleware that will be used by Express.</p>
<h3>Namespace Collision</h3>
<p>In the case of namespace collision, routes are handled sequentially by Express. Declare your custom routes
before using the middleware. For example:</p>
<pre><code>app.post('/api/login', myLoginHandler);
app.use('/api', preston.middleware());</code></pre>
<p>is the appropriate way to add functionality to your API.</p>
<h3>Route middleware</h3>
<p>There are 5 types of routes: query, create, get, update, and destroy. You can apply middleware to a single one of these routes by doing the following:</p>
<pre><code class="lang-js">model.use('get', function(req, res, next) {
  console.log('Get middleware on model ' + model.model.modelName + ' called!');
});</code></pre>
<p>You can also apply middleware to all of a model's routes:</p>
<pre><code class="lang-js">model.use('all', function(req, res, next) {
  console.log('Middleware on model ' + model.model.modelName + ' called!');
});</code></pre>
<p>The following fields are exposed in the request object:
<em> <code>doc</code> -- The document being retrieved, or null if not operating on a document route
</em> <code>parentDoc</code> -- The parent document being retrieved. Used for nested routes.
* <code>req.query</code> - The <code>populate</code> and <code>sort</code> fields are parsed beforehand, <code>populate</code> being an Array of Strings and <code>sort</code> being an object.</p>
<h4>Authentication middleware example with Passport</h4>
<p>Here is an example of using <a href="http://passportjs.org/">Passport</a> to restrict access to a document:</p>
<pre><code class="lang-js">model.use('get', function(req, res, next) {
  if (req.user._id !== req.doc.owner) {
    res.status(403).send('Unauthorized!');
  }
  return next();
});</code></pre>
<p>Passport exposes a <code>user</code> property on the request, so we can deal with that directly in our middleware. If we were to use something like <a href="https://github.com/ForbesLindesay/connect-roles">connect-roles</a>, we would do something like this:</p>
<pre><code class="lang-js">model.use('all', user.can('operate on the model'));</code></pre>
<h2>The Query Pipeline</h2>
<p>Preston was designed to be very flexible so it could be used as a backend for any app. Thus, queries go through a series of steps before being transformed into what is sent to the client.</p>
<pre><code>Modifiers --&gt; Parameters --&gt; Filters --&gt; Population --&gt; Execution --&gt; Transformers</code></pre>
<h3>Modifiers</h3>
<p>Modifiers alter the query parameters that will be passed to the pipeline. For example, you could have a modifier that forces sorting by name ascending, as shown below:</p>
<pre><code class="lang-js">model.modifyParam('sort', function(req, value) {
  value.name = 1;
  return value;
});</code></pre>
<p>To modify a parameter, just pass the name of the parameter you wish to modify and a callback that returns the modified value of the parameter.</p>
<p><code>sort</code> and <code>populate</code> are the only parameters that are objects.</p>
<p>The <code>sort</code> parameter looks like this:</p>
<pre><code class="lang-js">{
  name: 1, // Ascending
  date: -1 // Descending
}</code></pre>
<p>The <code>populate</code> parameter looks like this:</p>
<pre><code class="lang-js">['users', 'comments', 'posts']</code></pre>
<h3>Parameters</h3>
<p>There are 4 types of parameters: limit, skip, sort, and field equality. These are all described in the <a href="#query">Query</a> section.</p>
<h3>Filters</h3>
<p>Filters are user-defined functions that modify the query. They work very similarly to AngularJS filters. They can be chained and take parameters, allowing immense flexibility for developers to add features to APIs.</p>
<p>Filters are defined as follows:</p>
<pre><code class="lang-js">model.filter('children', function(req, query) {
  query.where('age').lt(18);
});</code></pre>
<p>Here is an example of a filter that takes parameters:</p>
<pre><code class="lang-js">model.filter('proximity', function(req, query, distance) {
  query.where('location').maxDistance(distance);
});</code></pre>
<p>This filter would be called using <code>proximity 5</code> if one wanted to check if the location was within a distance of 5.</p>
<p>Chaining filters is pretty simple; just use the <code>|</code> (pipe) operator to do so.</p>
<pre><code>GET /people?filter=children | proximity 5</code></pre>
<h3>Population</h3>
<p>Fields that were marked for population in the query are now populated. You can change what fields are returned using <a href="#population-transformers">population transformers</a>.</p>
<h3>Execution</h3>
<p>At this point in the pipeline, <code>query.exec()</code> is called and we query the database.</p>
<h3>Transformers</h3>
<p>Transformers change the returned results. One transformer is built in, the <code>restricted</code> transformer, and cannot be changed. Here is an example of using a transformer:</p>
<pre><code class="lang-js">model.transform(function(req, doc) {
  delete doc._id;
  delete doc.password;
  doc.type = 'This is a string that isn\'t in the database!';
});</code></pre>
<p>Transformers are applied to each individual document in a query result.</p>
<h4>Population Transformers</h4>
<p>Population transformers are transformers that operate on populated fields. They can be used to make your application more secure by removing fields you don't want people to see.</p>
<pre><code class="lang-js">model.transformPopulate('owners', function(req, doc) {
  delete doc._id;
  delete doc.password;
});</code></pre>
<h2>AngularJS Integration</h2>
<p>This software was built with <a href="https://angularjs.org/">Angular</a> in mind. Use the module <a href="https://github.com/mgonto/restangular">Restangular</a> to deal with the generated API
in a very intuitive manner.</p>
<h2>Example Apps</h2>
<p>Here are some apps that use Preston. If you have one you'd like to share, please don't be afraid to send a PR!</p>
<ul>
<li><a href="https://github.com/simplyianm/todo-preston">todo-preston</a> - A Preston-powered Todo app made with Angular, Restangular, Bootstrap, and Preston.</li>
</ul>
<h2>License</h2>
<p>Copyright (c) 2014 Ian Macalinao. Released under the MIT License, which can be viewed in the attached <code>LICENSE</code> file.</p></article>
    </section>







				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Copyright (c) 2014 Ian Macalinao. Released under the MIT License.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a>
		on Sun Aug 17th 2014 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<div class="span3">
				<div id="toc"></div>
			</div>
			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	

</body>
</html>