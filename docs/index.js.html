<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var express = require('express');
var _ = require('lodash');
var functionize = require('functionize');
var Model = require('./model');

/**
 * Represents a RESTful API powered by Restifier.
 *
 * @class
 */
function RestAPI() {
  this.models = {};
  this.router = express.Router();
  this.router.use(require('res-error')({
    log: false
  }));
}

/**
 * Gateway function that can add model(s) or return initialization
 * middleware depending on the arguments passed to it.
 *
 * @returns {Model|Function} A model or middleware depending on the arguments.
 * * `setup()` - Returns `this.router`
 * * `setup(mong)` - Returns `model(mong)`
 * * `setup(mong1, mong2)` - Returns `modelsMiddleware(mong1, mong2)`
 */
RestAPI.prototype.setup = function() {
  var args = Array.prototype.slice.call(arguments, 0);
  if (args.length > 1) {
    return this.modelsMiddleware(args);
  }

  if (args.length === 0 || !args[0].schema) {
    return this.router;
  }
  return this.model(args[0]);
};

/**
 * Creates a setup function for this RestAPI.
 */
RestAPI.prototype.asFunction = function() {
  return functionize(this, this.setup);
};

/**
 * Applies middleware to this RestAPI. Uses express.Router#use.
 *
 * @returns {RestAPI} This RestAPI.
 */
RestAPI.prototype.use = function() {
  this.router.use.apply(this.router, arguments);
  return this;
};

/**
 * Should be called after the app has been created.
 *
 * @returns {Function} Express middleware
 */
RestAPI.prototype.finish = function() {
  return function(req, res, next) {
    return res.error(404, 'Path not found.');
  };
};

/**
 * Adds a model to this RestAPI.
 *
 * @param {mongoose.Model} mong The mongoose model
 */
RestAPI.prototype.model = function(mong) {
  var m = new Model(this, mong);
  this.models[mong.modelName] = m;
  return m;
};

/**
 * Adds multiple models to this RestAPI.
 *
 * @param {mongoose.Model[]} mongs The mongoose models
 */
RestAPI.prototype.addModels = function(mongs) {
  return _.map(mongs, function(mong) {
    return this.model(mong);
  }, this);
};

/**
 * Creates a middleware out of multiple models.
 *
 * @param {mongoose.Model[]} mongs The mongoose models
 */
RestAPI.prototype.modelsMiddleware = function(mongs) {
  var router = express.Router();
  _.forEach(this.addModels(mongs), function(model) {
    model.serve(router);
  });
  return router;
};

/**
 * Creates middleware that encompasses all registered models.
 * This is equivalent to calling `model.middleware()` for each
 * individual model, plus calling `restifier.initialize()` and
 * `restifier.finish()`.
 *
 * @returns {Router} Returns an Express router containing all middlewares.
 */
RestAPI.prototype.middleware = function() {
  var router = express.Router();
  router.use(this.router);
  _.forEach(this.models, function(model) {
    router.use(model.middleware());
    _.forEach(model.submodels, function(submodel) {
      router.use(submodel.middleware());
    });
  });
  router.use(this.finish());
  return router;
};

/**
 * The main function. Wraps {@link RestAPI#setup}.
 *
 * @global
 * @see RestAPI#setup
 */
var restifier = module.exports = (new RestAPI()).asFunction();

/**
 * Factory function to create a new {@link RestAPI}.
 *
 * @name restifier.api
 * @global
 * @see RestAPI
 *
 * @returns RestAPI A new RestAPI.
 */
restifier.api = function() {
  return new RestAPI();
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="Model.html">Model</a></li><li><a href="RestAPI.html">RestAPI</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Mon Aug 18 2014 09:06:54 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
